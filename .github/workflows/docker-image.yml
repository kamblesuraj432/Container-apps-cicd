name: ECS CI/CD Pipeline
on: [push]

permissions:
  id-token: write
  contents: read

jobs:
  checkout-and-auth:
    name: ðŸ” Source Setup & AWS Auth
    runs-on: ubuntu-latest
    outputs:
      image-tag: ${{ steps.set-tag.outputs.image_tag }}
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4
      
      - name: ðŸ”‘ Configure AWS Credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::050451400373:role/Github-ECS-cicd-role
          aws-region: us-east-1
          mask-aws-account-id: false
      
      - name: ðŸ·ï¸ Set Image Tag
        id: set-tag
        run: |
          echo "image_tag=${{ github.sha }}" >> $GITHUB_OUTPUT

  build-and-push:
    name: ðŸ³ Build & Push to ECR
    needs: checkout-and-auth
    runs-on: ubuntu-latest
    outputs:
      image-uri: ${{ steps.push-image.outputs.image_uri }}
    steps:
      - name: ðŸ”’ Login to Amazon ECR
        id: ecr-login
        uses: aws-actions/amazon-ecr-login@v1
      
      - name: ðŸ› ï¸ Build Docker Image
        env:
          ECR_REGISTRY: ${{ steps.ecr-login.outputs.registry }}
          ECR_REPOSITORY: test-repo-hello-world
          IMAGE_TAG: ${{ needs.checkout-and-auth.outputs.image-tag }}
        run: |
          docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG .
      
      - name: â¬†ï¸ Push to ECR
        id: push-image
        env:
          ECR_REGISTRY: ${{ steps.ecr-login.outputs.registry }}
          ECR_REPOSITORY: test-repo-hello-world
          IMAGE_TAG: ${{ needs.checkout-and-auth.outputs.image-tag }}
        run: |
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          echo "image_uri=$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG" >> $GITHUB_OUTPUT

  deploy-to-ecs:
    name: ðŸš€ ECS Deployment
    needs: [checkout-and-auth, build-and-push]
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ”‘ Configure AWS Credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::<AWS_ACCOUNT_ID>:role/<IAM_ROLE_NAME>
          aws-region: us-east-1
      
      - name: ðŸ“ Update Task Definition
        id: update-task
        env:
          IMAGE_URI: ${{ needs.build-and-push.outputs.image-uri }}
        run: |
          # Install jq for JSON processing
          sudo apt-get install -y jq
          
          # Get current task definition
          CURRENT_TASK=$(aws ecs describe-task-definition \
            --task-definition your-task-definition-family)
          
          # Update container image
          UPDATED_TASK=$(echo $CURRENT_TASK | jq \
            --arg IMAGE "$IMAGE_URI" \
            '.taskDefinition.containerDefinitions[0].image = $IMAGE')
          
          # Prepare clean task definition
          FILTERED_TASK=$(echo $UPDATED_TASK | jq '.taskDefinition | 
            del(.taskDefinitionArn, .revision, .status, 
                .requiresAttributes, .compatibilities, 
                .registeredAt, .registeredBy)')
          
          # Register new revision
          NEW_TASK=$(aws ecs register-task-definition \
            --cli-input-json "$FILTERED_TASK")
          
          # Extract new revision number
          NEW_REV=$(echo $NEW_TASK | jq -r '.taskDefinition.revision')
          echo "NEW_REVISION=$NEW_REV" >> $GITHUB_ENV
      
      - name: ðŸš€ Deploy to ECS
        run: |
          aws ecs update-service \
            --cluster your-cluster \
            --service your-service \
            --task-definition your-task-definition-family:$NEW_REVISION \
            --force-new-deployment
      
      - name: âœ… Verify Deployment
        run: |
          aws ecs wait services-stable \
            --cluster your-cluster \
            --services your-service \
            --region us-east-1
